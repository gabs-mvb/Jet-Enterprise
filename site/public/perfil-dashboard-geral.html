<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Informações Gerais</title>
  <link rel="stylesheet" href="css/perfil-sidebar.css">
  <link rel="stylesheet" href="css/perfil-dashboard-geral.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.min.css'>

</head>

<body onload="mostrarkpi(), obterPie(), setorMenosAbastecido(), statusPredominanteMes()">

  <main>

    <!--Dashboard-->

    <header>

      <!--Titulo do dashboard-->
      <section class="dashboard-titulo">
        <h1>Informações gerais</h1>
      </section>

    </header>

    <!--Sessão de KPIs-->
    <div class="dashboard-kpis">
      <div id="div_kpi_dado" class="kpis kpi-status-informacoes_gerais">
        <p class="kpi-titulo">Status do mercado</p>
        <p id="kpi_dado" class="kpi-dado"></p>
        <span id="kpi_abastecimento" class="kpi-dado-palavra-ajuste"></span>
      </div>
      <div id="kpi_menor_percentual" class="kpis ">
        <p class="kpi-titulo">Setor com maior falta de produtos </p>
        <p id="kpiComMenorPercentual" class="kpi-flex"></p>
        <span id="SetorMenorPercentual"class="kpi-dado-palavra-ajuste"></span>
      </div>
      <div id="kpi_status_predominante_mes" class="kpis ">
        <p class="kpi-titulo">Status predominante no mês</p>
        <p id="estadoPredominanteMes" class="kpi-dado"></p>
        <span id="percentualPredominanteMes" class="kpi-dado-palavra-ajuste"></span>
      </div>
    </div>

    <!--Sessão de Gráficos-->
    <div class="dashboard-graficos">
      <div class="graficos-card">
        <div class="titulo-estado-gondolas">
          Estado atual das gôndolas (%)
        </div>
        <div id="grafico" class="graficos-container container-grafico-pizza-mercado">
          <!-- <canvas class="graficos-canvas" id="pizza_estado_mercado"></canvas> -->
        </div>
      </div>
      <div class="graficos-card">
        <div class="titulo-fluxo-produtos">
          Fluxo dos setores por mês - Quantas vezes os sensores detectaram ausência de produto
        </div>
        <div class="graficos-container container-grafico-linha-fluxo">
          <canvas class="graficos-canvas" id="linha_fluxo_setores"></canvas>
        </div>
      </div>
    </div>

    <!--Sessões e Categorias-->
    <div class="dashboard-sessoes">
      <div class="sessoes sessao-porcentagem-setor">
        <p>Abastecimento por setor</p>
        <ul class="titulos-setores">
          <li>Frios e congelados:</li>
          <li>Mercearia:</li>
          <li>Hortifruti:</li>
          <li>Cuidados pessoais:</li>
          <li>Bebidas:</li>
        </ul>
        <ul class="porcentagem-setores">
          <li> <span id="SetorFrios" class=""></span></li>
          <li> <span id="SetorMercearia" class=""></span></li>
          <li> <span id="SetorHortifruti" class=""></span></li>
          <li> <span id="SetorCuidados" class=""></span></li>
          <li> <span id="SetorBebidas" class=""></span></li>
        </ul>
        <ul class="cor-setores">
          <li>
            <div id="linha_frios" class=""></div>
          </li>
          <li>
            <div id="linha_mercearia" class=""></div>
          </li>
          <li>
            <div id="linha_hortifruti" class=""></div>
          </li>
          <li>
            <div id="linha_cuidados" class=""></div>
          </li>
          <li>
            <div id="linha_bebidas" class=""></div>
          </li>
        </ul>
      </div>

      <!--Categorias-->
      <div class="sessoes sessao-categorias">
        <h2>Categorias</h2>
        <ul class="categorias">
          <li><a href="perfil-dashboard-geral.html">
              <div class="container-categorias">
                <div class="titulos-categorias">
                  Informações gerais
                </div>
                <div>
                  <img src="assets/perfil/dashboard/seta-lateral.svg" class="svg-seta"
                    alt="Seta lateral indicando um link">
                </div>
              </div>
            </a></li>
          <li><a href="perfil-dashboard-sensores-frios-congelados.html">
              <div class="container-categorias">
                <div class="titulos-categorias">
                  Estado dos sensores
                </div>
                <div>
                  <img src="assets/perfil/dashboard/seta-lateral.svg" class="svg-seta"
                    alt="Seta lateral indicando um link">
                </div>
              </div>
            </a></li>
          <li><a href="perfil-dashboard-produtos.html">
              <div class="container-categorias">
                <div class="titulos-categorias">
                  Fluxo dos produtos
                </div>
                <div>
                  <img src="assets/perfil/dashboard/seta-lateral.svg" class="svg-seta"
                    alt="Seta lateral indicando um link">
                </div>
              </div>
            </a></li>
        </ul>
      </div>
    </div>

    <!--Fundo Azul-->
    <div class="background-color">


      <!-- SideBar do Perfil-->
      <div class="sidebar">
        <img src="uploads/user.svg" id="iconePerfil" class="icone-perfil" />
        <h3><span id="b_usuario">Nome Completo</span></h3>
        <nav>
          <ul class="sidebar-lista">
            <li>
              <a href="perfil-dashboard-empresa.html">
                <img src="assets/svg/empresa.svg" class="sidebar-icone-lista" width="50" height="54" viewBox="0 0 47 51" alt="">
    
                <span href="perfil-dashboard-empresa.html" class="sidebar-titulo">Empresa</span>
              </a>
            </li>
            <div class="sidebar-separacao"></div>
            <li>
              <a href="perfil-produtos-frios-congelados.html">
                <img src="assets/svg/produtos.svg" class="sidebar-icone-lista" width="50" height="54" viewBox="0 0 47 51" alt="">
                <span class="sidebar-titulo">Produtos</span>
              </a>
            </li>
            <div class="sidebar-separacao"></div>
            <li>
              <a href="perfil-dashboard-geral.html">
                <img src="assets/svg/dashboard.svg" class="sidebar-icone-lista" width="50" height="54" viewBox="0 0 47 51" alt="">
                <span class="sidebar-titulo">Dashboard</span>
              </a>
            </li>
            <div class="sidebar-separacao"></div>
            <li>
              <a href="perfil-notificacoes.html">
                <img src="assets/svg/notificacoes.svg" class="sidebar-icone-lista" width="50" height="54" viewBox="0 0 47 51" alt="">
                <span class="sidebar-titulo">Notificações</span>
              </a>
            </li>
            <div class="sidebar-separacao"></div>
            <li>
              <a href="perfil-config.html">
                <img src="assets/svg/configuracoes.svg" class="sidebar-icone-lista" width="50" height="54" viewBox="0 0 47 51" alt="">
                <span class="sidebar-titulo">Configurações</span>
              </a>
            </li>
            <li>
              <a href="https://suportejet.auvo.com.br/Ticket/Novo" target="_blank">
                <img src="assets/svg/suporte.svg" class="sidebar-icone-lista" width="50" height="54" viewBox="0 0 47 51" alt="">
                <span class="sidebar-titulo">Suporte</span>
              </a>
            </li>
            <div class="sidebar-separacao"></div>
            <li>
              <a href="index.html">
                <img src="assets/svg/logo.svg" class="sidebar-icone-lista" width="50" height="54" viewBox="0 0 47 51" alt="">
    
                <span class="sidebar-titulo">JET - Tela Inicial</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </main>

  <footer>
    <!--Espaço vazio no fim do dashboard-->
    <div class="footer-space"></div>
  </footer>

</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.all.min.js"></script>
<script src="js/perfil-dashboard-geral.js"></script>

</html>
<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  iconePerfil.src = sessionStorage.PERFIL_IMAGEM;
</script>

<script>

  function mostrarkpi() {

    var idEmpresa = sessionStorage.ID_EMPRESA;

    fetch(`/kpigeral/kpisdashboardgeral/${idEmpresa}`).then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {
          Swal.fire({
          icon: 'error',
          title: 'Ops...',
          text: 'Nenhuma prateleira encontrada!',
          })
        }
        resposta.json().then(function (resposta) {
          console.log("Dados recebidos: ", JSON.stringify(resposta));

          for (let i = 0; i < resposta.length; i++) {
            var porcentagem = resposta[i];
            console.log(porcentagem.conta)

            kpi_abastecimento.innerHTML = `${porcentagem.conta}% abastecido`

            if (porcentagem.conta < 75) {
              kpi_dado.innerHTML = `Crítico`;
              div_kpi_dado.classList.remove('amarelo');
              div_kpi_dado.classList.remove('verde-lima');
              div_kpi_dado.classList.remove('verde-escuro');
              div_kpi_dado.classList.add('vermelho');
            } else if (porcentagem.conta < 85) {
              kpi_dado.innerHTML = `Alerta`;
              div_kpi_dado.classList.remove('verde-lima');
              div_kpi_dado.classList.remove('verde-escuro');
              div_kpi_dado.classList.remove('vermelho');
              div_kpi_dado.classList.add('amarelo');
            } else if (porcentagem.conta < 95) {
              kpi_dado.innerHTML = `Bom`;
              div_kpi_dado.classList.remove('amarelo');
              div_kpi_dado.classList.remove('vermelho');
              div_kpi_dado.classList.remove('verde-escuro');
              div_kpi_dado.classList.add('verde-lima');
            } else {
              kpi_dado.innerHTML = `Ótimo`;
              div_kpi_dado.classList.remove('verde-amarelo');
              div_kpi_dado.classList.remove('vermelhor');
              div_kpi_dado.classList.remove('verde-lima');
              div_kpi_dado.classList.add('verde-escuro');
            }

          }
        });
      } else {
        throw ('Houve um erro na API!');
      }
    }).catch(function (resposta) {
      console.error(resposta);
    });
    setTimeout(() => mostrarkpi(), 16000);
  }

  function setorMenosAbastecido() {

    var idEmpresa = sessionStorage.ID_EMPRESA;

    fetch(`kpigeral/kpiMenosAbastecido/${idEmpresa}`).then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {
          Swal.fire({
          icon: 'error',
          title: 'Ops...',
          text: 'Nenhuma prateleira encontrada!',
          })
        }
        resposta.json().then(function (resposta) {
          console.log("Dados recebidos: ", JSON.stringify(resposta))

          var frios = resposta[0].abastecimento_frios
          var mercearia = resposta[0].abastecimento_mercearia
          var hortifruti = resposta[0].abastecimento_hortifruti
          var cuidadosPessoais = resposta[0].abastecimento_cuidados
          var bebidas = resposta[0].abastecimento_bebidas


          var menosAbastecido = Math.min(frios, mercearia, hortifruti, cuidadosPessoais, bebidas)
          var setor = 0

          kpiComMenorPercentual.innerHTML = menosAbastecido + '% <span class="kpi-subtitulo">de abastecimento</span>'

          if (menosAbastecido == frios) {
            setor = 'Frios e congelados'
          } else if (menosAbastecido == mercearia) {
            setor = 'Mercearia'
          } else if (menosAbastecido == hortifruti) {
            setor = 'Hortifruti'
          } else if (menosAbastecido == cuidadosPessoais) {
            setor = 'Cuidados Pessoais'
          } else if (menosAbastecido == bebidas) {
            setor = 'Bebidas'
          }


          SetorMenorPercentual.innerHTML = setor;

          SetorFrios.innerHTML = `${frios}% abastecido`;

          SetorMercearia.innerHTML = `${mercearia}% abastecido`;

          SetorHortifruti.innerHTML = `${hortifruti}% abastecido`;

          SetorCuidados.innerHTML = `${cuidadosPessoais}% abastecido`;

          SetorBebidas.innerHTML = `${bebidas}% abastecido`;

          /* KPI de percentual do setor menos abastecido */
          if (menosAbastecido < 75) {
            kpi_menor_percentual.classList.remove('amarelo');
            kpi_menor_percentual.classList.remove('verde-lima');
            kpi_menor_percentual.classList.remove('verde-escuro');
            kpi_menor_percentual.classList.add('vermelho');
          } else if (menosAbastecido < 85) {
            kpi_menor_percentual.classList.remove('vermelho');
            kpi_menor_percentual.classList.remove('verde-lima');
            kpi_menor_percentual.classList.remove('verde-escuro');
            kpi_menor_percentual.classList.add('amarelo');
          } else if (menosAbastecido < 95) {
            kpi_menor_percentual.classList.remove('amarelo');
            kpi_menor_percentual.classList.remove('vermelho');
            kpi_menor_percentual.classList.remove('verde-escuro');
            kpi_menor_percentual.classList.add('verde-lima');
          } else {
            kpi_menor_percentual.classList.remove('amarelo');
            kpi_menor_percentual.classList.remove('vermelho');
            kpi_menor_percentual.classList.remove('verde-lima');
            kpi_menor_percentual.classList.add('verde-escuro');
          }


          /* Linha de frios e congelados */
          if (frios <  75) {
            linha_frios.classList.remove('linha-amarela');
            linha_frios.classList.remove('linha-verde-lima');
            linha_frios.classList.remove('linha-verde-escura');
            linha_frios.classList.add('linha-vermelha');
          } else if (frios < 85) {
            linha_frios.classList.remove('linha-vermelha');
            linha_frios.classList.remove('linha-verde-lima');
            linha_frios.classList.remove('linha-verde-escuro');
            linha_frios.classList.add('linha-amarela');
          } else if (frios < 95) {
            linha_frios.classList.remove('linha-amarela');
            linha_frios.classList.remove('linha-vermelha');
            linha_frios.classList.remove('linha-verde-escuro');
            linha_frios.classList.add('linha-verde-lima');
          } else {
            linha_frios.classList.remove('linha-amarela');
            linha_frios.classList.remove('linha-vermelha');
            linha_frios.classList.remove('linha-verde-lima');
            linha_frios.classList.add('linha-verde-escuro');
          }


          /* Linha da Mercearia */
          if (mercearia < 75) {
            linha_mercearia.classList.remove('linha-amarela');
            linha_mercearia.classList.remove('linha-verde-lima');
            linha_mercearia.classList.remove('linha-verde-escura');
            linha_mercearia.classList.add('linha-vermelha');
          } else if (mercearia < 85) {
            linha_mercearia.classList.remove('linha-vermelha');
            linha_mercearia.classList.remove('linha-verde-lima');
            linha_mercearia.classList.remove('linha-verde-escuro');
            linha_mercearia.classList.add('linha-amarela');
          } else if (mercearia < 95) {
            linha_mercearia.classList.remove('linha-amarela');
            linha_mercearia.classList.remove('linha-vermelha');
            linha_mercearia.classList.remove('linha-verde-escuro');
            linha_mercearia.classList.add('linha-verde-lima');
          } else {
            linha_mercearia.classList.remove('linha-amarela');
            linha_mercearia.classList.remove('linha-vermelha');
            linha_mercearia.classList.remove('linha-verde-lima');
            linha_mercearia.classList.add('linha-verde-escuro');
          }


          /* Linha Hortifruti */
          if (hortifruti < 75) {
            linha_hortifruti.classList.remove('linha-amarela');
            linha_hortifruti.classList.remove('linha-verde-lima');
            linha_hortifruti.classList.remove('linha-verde-escura');
            linha_hortifruti.classList.add('linha-vermelha');
          } else if (hortifruti < 85) {
            linha_hortifruti.classList.remove('linha-vermelha');
            linha_hortifruti.classList.remove('linha-verde-lima');
            linha_hortifruti.classList.remove('linha-verde-escuro');
            linha_hortifruti.classList.add('linha-amarela');
          } else if (hortifruti < 95) {
            linha_hortifruti.classList.remove('linha-amarela');
            linha_hortifruti.classList.remove('linha-vermelha');
            linha_hortifruti.classList.remove('linha-verde-escuro');
            linha_hortifruti.classList.add('linha-verde-lima');
          } else {
            linha_hortifruti.classList.remove('linha-amarela');
            linha_hortifruti.classList.remove('linha-vermelha');
            linha_hortifruti.classList.remove('linha-verde-lima');
            linha_hortifruti.classList.add('linha-verde-escuro');
          }


          /* Linha Cuidados Pessoais */
          if (cuidadosPessoais < 75) {
            linha_cuidados.classList.remove('linha-amarela');
            linha_cuidados.classList.remove('linha-verde-lima');
            linha_cuidados.classList.remove('linha-verde-escura');
            linha_cuidados.classList.add('linha-vermelha');
          } else if (cuidadosPessoais < 85) {
            linha_cuidados.classList.remove('linha-vermelha');
            linha_cuidados.classList.remove('linha-verde-lima');
            linha_cuidados.classList.remove('linha-verde-escuro');
            linha_cuidados.classList.add('linha-amarela');
          } else if (cuidadosPessoais < 95) {
            linha_cuidados.classList.remove('linha-amarela');
            linha_cuidados.classList.remove('linha-vermelha');
            linha_cuidados.classList.remove('linha-verde-escuro');
            linha_cuidados.classList.add('linha-verde-lima');
          } else {
            linha_cuidados.classList.remove('linha-amarela');
            linha_cuidados.classList.remove('linha-vermelha');
            linha_cuidados.classList.remove('linha-verde-lima');
            linha_cuidados.classList.add('linha-verde-escuro');
          }


          /* Linha Bebidas */
          if (bebidas < 75) {
            linha_bebidas.classList.remove('linha-amarela');
            linha_bebidas.classList.remove('linha-verde-lima');
            linha_bebidas.classList.remove('linha-verde-escura');
            linha_bebidas.classList.add('linha-vermelha');
          } else if (bebidas < 85) {
            linha_bebidas.classList.remove('linha-vermelha');
            linha_bebidas.classList.remove('linha-verde-lima');
            linha_bebidas.classList.remove('linha-verde-escuro');
            linha_bebidas.classList.add('linha-amarela');
          } else if (bebidas < 95) {
            linha_bebidas.classList.remove('linha-amarela');
            linha_bebidas.classList.remove('linha-vermelha');
            linha_bebidas.classList.remove('linha-verde-escuro');
            linha_bebidas.classList.add('linha-verde-lima');
          } else {
            linha_bebidas.classList.remove('linha-amarela');
            linha_bebidas.classList.remove('linha-vermelha');
            linha_bebidas.classList.remove('linha-verde-lima');
            linha_bebidas.classList.add('linha-verde-escuro');
          }

        });
      } else {
        throw ('Houve um erro na API!');
      }
    }).catch(function (resposta) {
      console.error(resposta);
    });
    setTimeout(() => setorMenosAbastecido(), 16000);
  }

  function statusPredominanteMes() {
    var idEmpresa = sessionStorage.ID_EMPRESA;

    fetch(`kpigeral/kpiStatusPredominanteMes/${idEmpresa}`).then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {

          Swal.fire({
          icon: 'error',
          title: 'Ops...',
          text: 'Nenhuma prateleira encontrada!',
          })
        }
        resposta.json().then(function (resposta) {
          console.log("Dados recebidos: ", JSON.stringify(resposta))

          var status = resposta[0].estado_predominante_mes
          
          percentualPredominanteMes.innerHTML = `${status}% abastecido`

          if(status < 75){
            estadoPredominanteMes.innerHTML = `Crítico`;
            kpi_status_predominante_mes.classList.remove('amarela')
            kpi_status_predominante_mes.classList.remove('verde-lima')
            kpi_status_predominante_mes.classList.remove('verde-escuro')
            kpi_status_predominante_mes.classList.add('vermelho')
          }else if(status < 85){
            estadoPredominanteMes.innerHTML = `Alerta`;
            kpi_status_predominante_mes.classList.remove('vermelho');
            kpi_status_predominante_mes.classList.remove('verde-lima');
            kpi_status_predominante_mes.classList.remove('verde-escuro');
            kpi_status_predominante_mes.classList.add('amarelo');
          }else if(status < 95){
            estadoPredominanteMes.innerHTML = `Bom`;
            kpi_status_predominante_mes.classList.remove('amarelo');
            kpi_status_predominante_mes.classList.remove('vermelho');
            kpi_status_predominante_mes.classList.remove('verde-escuro');
            kpi_status_predominante_mes.classList.add('verde-lima');
          }else{
            estadoPredominanteMes.innerHTML = `Ótimo`;
            kpi_status_predominante_mes.classList.remove('amarelo');
            kpi_status_predominante_mes.classList.remove('vermelho');
            kpi_status_predominante_mes.classList.remove('verde-lima');
            kpi_status_predominante_mes.classList.add('verde-escuro');
          }
        });
      } else {
        throw ('Houve um erro na API!');
      }
    }).catch(function (resposta) {
      console.error(resposta);
    });
    setTimeout(() => statusPredominanteMes(), 16000);
  }
</script>